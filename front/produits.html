<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Produits</title>
    <style>
        /* Global Styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
        }

        nav {
            background-color: #444;
            overflow: hidden;
            padding: 10px;
        }

        nav a {
            color: white;
            padding: 14px 20px;
            display: inline-block;
            text-decoration: none;
        }

        nav a:hover {
            background-color: #ddd;
            color: black;
        }

        header {
            text-align: center;
            margin: 2rem 0;
        }

        h1 {
            margin: 0;
            font-size: 2.5rem;
            color: #444;
        }

        .form-container {
            max-width: 500px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .form-container input,
        .form-container select,
        .form-container textarea {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .form-container button {
            width: 100%;
            padding: 1rem;
            background-color: #4caf50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .form-container button:hover {
            background-color: #45a049;
        }

        .produits {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .produit-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: white;
        }

        .produit-card h3 {
            margin: 0;
        }

        .btn {
            padding: 0.5rem 1rem;
            background-color: #4caf50;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }

        .btn:hover {
            background-color: #45a049;
        }

        footer {
            text-align: center;
            margin: 2rem 0;
            padding: 1rem;
            background-color: #444;
            color: white;
        }
    </style>
</head>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-auth.js";
    import { getFirestore, enableIndexedDbPersistence, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, getDoc, enableNetwork } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA-NyzpyeUgA8ElI9-isZJNMBiCP76BYhs",
        authDomain: "fleurdepau-1ce7d.firebaseapp.com",
        projectId: "fleurdepau-1ce7d",
        storageBucket: "fleurdepau-1ce7d.appspot.com",
        messagingSenderId: "394738141831",
        appId: "1:394738141831:web:a0cd5b9d0227267b248622",
        measurementId: "G-D1J6X7BH9S"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    window.db = db;
    window.auth = auth;

    enableIndexedDbPersistence(db).catch((err) => {
        console.error("‚ùå Erreur de persistance Firestore :", err);
    });

    async function verifierConnexionFirestore() {
        try {
            await enableNetwork(db);
            console.log("‚úÖ Firestore en ligne !");
        } catch (error) {
            console.warn("‚ö†Ô∏è Firestore hors ligne. Nouvelle tentative dans 10 secondes...");
            setTimeout(verifierConnexionFirestore, 10000);
        }
    }
    verifierConnexionFirestore();

    onAuthStateChanged(auth, (user) => {
        if (user) {
            if (user.isAnonymous) {
                console.warn("‚ö†Ô∏è D√©connexion de l'utilisateur anonyme...");
                signOut(auth).then(() => {
                    window.location.href = "login.html";
                });
            } else {
                console.log("‚úÖ Utilisateur connect√© :", user.email || "Utilisateur authentifi√©");
            }
        } else {
            console.warn("‚ö†Ô∏è Aucun utilisateur connect√©, redirection vers la connexion...");
            window.location.href = "login.html";
        }
    });

    async function sauvegarderProduit(event, collectionName) {
        event.preventDefault();

        const btnSauvegarde = document.getElementById('btn-sauvegarde');
        const produitId = btnSauvegarde.getAttribute('data-id');

        const nom = document.getElementById('nom-produit').value.trim();
        const description = document.getElementById('description-produit').value.trim();
        const prix = parseFloat(document.getElementById('prix-produit').value);
        const imageUrl = document.getElementById('image-url').value.trim();
        const couleursInput = document.getElementById('couleurs-produit').value.split(',').map(c => c.trim()).filter(c => c);

        let couleurs = [];
        couleursInput.forEach(couleur => {
            const stock = parseInt(document.getElementById(`stock-${couleur}`)?.value || 0);
            couleurs.push({ couleur, stock });
        });

        if (!nom || !description || isNaN(prix) || prix <= 0 || !imageUrl) {
            alert("Veuillez remplir tous les champs correctement.");
            return;
        }

        const produitData = { nom, description, prix, imageUrl, couleurs };

        try {
            if (produitId) {
                await updateDoc(doc(db, collectionName, produitId), produitData);
                alert("‚úÖ Produit mis √† jour !");
            } else {
                await addDoc(collection(db, collectionName), produitData);
                alert("‚úÖ Nouveau produit ajout√© !");
            }

            obtenirProduits(collectionName);
            document.getElementById('form-produit').reset();
            btnSauvegarde.removeAttribute('data-id');
            btnSauvegarde.textContent = 'Ajouter le produit';

        } catch (error) {
            console.error("‚ùå Erreur lors de l'enregistrement du produit : ", error);
            alert("Erreur lors de l'enregistrement du produit. Veuillez r√©essayer.");
        }
    }

    async function obtenirProduits(collectionName) {
        console.log("üîÑ Tentative de r√©cup√©ration des produits...");
        const produitsRef = collection(db, collectionName);

        try {
            const querySnapshot = await getDocs(produitsRef);
            const produitsContainer = document.getElementById(`produits-container-${collectionName.replace(/\s/g, '-').toLowerCase()}`);

            if (produitsContainer) {
                produitsContainer.innerHTML = querySnapshot.empty ? "<p>Aucun produit trouv√©.</p>" : "";

                querySnapshot.forEach(docSnapshot => {
                    const produit = docSnapshot.data();
                    const couleursHTML = produit.couleurs ? produit.couleurs.map(couleurData => {
                        const { couleur, stock } = couleurData;
                        return `<option value="${couleur}">${couleur} (${stock} en stock)</option>`;
                    }).join("") : 'Aucune couleur disponible';

                    produitsContainer.innerHTML += `

                        <div class="produit-card">
                            <h3>${produit.nom}</h3>
                            <p><strong>ID:</strong> ${docSnapshot.id}</p>
                            <p><strong>Description:</strong> ${produit.description}</p>
                            <p><strong>Prix:</strong> ${produit.prix}‚Ç¨</p>
                            <p><strong>Couleurs:</strong>
                                <select id="couleur-${docSnapshot.id}">
                                    ${couleursHTML}
                                </select>
                            </p>
                            <img src="${produit.imageUrl}" alt="${produit.nom}" width="100">
                            <button class="btn-modifier" data-id="${docSnapshot.id}">Modifier</button>
                            <button class="btn-supprimer" data-id="${docSnapshot.id}">Supprimer</button>
                        </div>
                    `;
                });

                ajouterEvenements();
                console.log("‚úÖ Produits r√©cup√©r√©s avec succ√®s !");
            }
        } catch (error) {
            console.error("‚ùå Erreur lors de la r√©cup√©ration des produits :", error);
            alert("Impossible de r√©cup√©rer les produits. Veuillez v√©rifier votre connexion.");
        }
    }

    function ajouterEvenements() {
        document.querySelectorAll('.btn-modifier').forEach(button => {
            button.addEventListener('click', async function () {
                const produitId = button.getAttribute('data-id');
                const produitRef = doc(db, 'fleur', produitId);
                const produitSnap = await getDoc(produitRef);

                if (produitSnap.exists()) {
                    const produit = produitSnap.data();
                    document.getElementById('nom-produit').value = produit.nom;
                    document.getElementById('description-produit').value = produit.description;
                    document.getElementById('prix-produit').value = produit.prix;
                    document.getElementById('image-url').value = produit.imageUrl;

                    let couleursHTML = '';
                    produit.couleurs.forEach(couleurData => {
                        const { couleur, stock } = couleurData;
                        couleursHTML += `

                            <div>
                                <input type="text" value="${couleur}" disabled> Stock: 
                                <input type="number" id="stock-${couleur}" value="${stock}" min="0">
                            </div>
                        `;
                    });
                    document.getElementById('stock-fields').innerHTML = couleursHTML;

                    const btnSauvegarde = document.getElementById('btn-sauvegarde');
                    btnSauvegarde.setAttribute('data-id', produitId);
                    btnSauvegarde.textContent = 'Mettre √† jour le produit';
                } else {
                    alert("Produit non trouv√©.");
                }
            });
        });

        document.querySelectorAll('.btn-supprimer').forEach(button => {
            button.addEventListener('click', async function () {
                const produitId = button.getAttribute('data-id');
                const produitRef = doc(db, 'fleur', produitId);

                try {
                    await deleteDoc(produitRef);
                    alert("‚úÖ Produit supprim√© avec succ√®s !");
                    obtenirProduits("fleur");
                } catch (error) {
                    console.error("‚ùå Erreur lors de la suppression du produit :", error);
                    alert("Impossible de supprimer le produit. Veuillez r√©essayer.");
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        obtenirProduits("fleur");
        obtenirProduits("porte cl√©");
    });
</script>

<body>
    <nav>
        <a href="#fleur">Fleur</a>
        <a href="#porte-key">Porte-Cl√©</a>
    </nav>

    <header>
        <h1>Gestion des Produits</h1>
    </header>

    <div class="form-container">
        <form id="form-produit" onsubmit="sauvegarderProduit(event, 'fleur')">
            <label for="nom-produit">Nom du produit</label>
            <input type="text" id="nom-produit" required>

            <label for="description-produit">Description</label>
            <textarea id="description-produit" required></textarea>

            <label for="prix-produit">Prix</label>
            <input type="number" id="prix-produit" step="0.01" required>

            <label for="image-url">URL de l'image</label>
            <input type="text" id="image-url" required>

            <label for="couleurs-produit">Couleurs disponibles (s√©par√©es par des virgules)</label>
            <input type="text" id="couleurs-produit">

            <div id="stock-fields"></div>

            <button type="submit" id="btn-sauvegarde">Ajouter le produit</button>
        </form>
    </div>

    <div class="produits" id="produits-container-fleur"></div>
    <div class="produits" id="produits-container-porte-key"></div>

    <footer>
        <p>¬© 2025 Fleur de Pau. Tous droits r√©serv√©s.</p>
    </footer>

</body>

</html>
